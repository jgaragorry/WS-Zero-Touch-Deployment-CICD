# =============================================================================
# WORKSHOP #4: ZERO TOUCH DEPLOYMENT (CI/CD)
# Autor: SoftrainCorp
# Objetivo: Orquestar todo el ciclo de vida de la aplicaci√≥n autom√°ticamente.
# =============================================================================

name: "üöÄ Zero Touch Deploy"

# 1. DISPARADORES (TRIGGERS)
# Define CU√ÅNDO debe despertar el robot.
on:
  push:
    branches:
      - main  # Solo se activa cuando hay c√≥digo nuevo en la rama 'main'
    paths:
      # FILTRO FINOPS: Solo correr si cambiaron archivos relevantes.
      # Si cambias solo el README, esto NO gasta minutos de GitHub Actions.
      - 'app/**'
      - 'terraform/**'
      - '.github/workflows/deploy.yaml'

# 2. SEGURIDAD OIDC (Sin Llaves)
# Permite que GitHub solicite un "pase temporal" a AWS sin guardar credenciales fijas.
permissions:
  id-token: write   # Necesario para autenticarse con AWS
  contents: read    # Necesario para leer tu c√≥digo

# 3. VARIABLES GLOBALES
env:
  AWS_REGION: "us-east-1"
  TF_VERSION: "1.10.0"  # ‚ö†Ô∏è CR√çTICO: Debe ser >= 1.10.0 para usar S3 Native Locking

jobs:
  deploy:
    name: "Build & Deploy Infrastructure"
    runs-on: ubuntu-latest # Usamos una m√°quina Linux prestada por GitHub
    defaults:
      run:
        working-directory: ./terraform # Por defecto, trabajamos en la carpeta de infraestructura

    steps:
      # --- FASE 1: PREPARACI√ìN DEL ENTORNO ---
      
      - name: üì• 1. Checkout Code
        uses: actions/checkout@v4
        # Descarga tu repositorio en la m√°quina virtual.

      - name: üîê 2. Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }} # Tu rol "GitHubActionsDeployRole"
          aws-region: ${{ env.AWS_REGION }}

      - name: üõ†Ô∏è 3. Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          # Instala el binario de Terraform para poder ejecutar comandos.

      # --- FASE 2: INFRAESTRUCTURA BASE (Terraform) ---
      
      - name: üèóÔ∏è 4. Terraform Init & Apply (Base)
        run: |
          terraform init
          
          # Desplegamos la infraestructura (VPC, ALB, ECR).
          # TRUCO: Como la imagen ECR a√∫n no existe en la primera ejecuci√≥n,
          # usamos Nginx p√∫blico para que ECS no falle al iniciar.
          terraform apply -auto-approve \
            -var="app_image=public.ecr.aws/nginx/nginx:latest"

      # --- FASE 3: CONSTRUCCI√ìN DE SOFTWARE (Docker Build) ---

      - name: üîç 5. Get ECR Repo URL
        id: ecr
        run: |
          # Extraemos la URL del repo que Terraform acaba de crear
          echo "REPO_URL=$(terraform output -raw ecr_repo_url)" >> $GITHUB_ENV

      - name: üê≥ 6. Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        # Autentica Docker local contra tu AWS ECR privado.

      - name: üì¶ 7. Build, Tag, and Push Docker Image
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPOSITORY: ${{ env.REPO_URL }}
          IMAGE_TAG: ${{ github.sha }} # Usamos el Hash del Commit para trazabilidad exacta
        working-directory: ./app # ¬°OJO! Cambiamos a la carpeta de la App
        run: |
          echo "Construyendo imagen: $REPOSITORY:$IMAGE_TAG"
          docker build -t $REPOSITORY:$IMAGE_TAG .
          docker push $REPOSITORY:$IMAGE_TAG
          # Guardamos la URI completa para el siguiente paso
          echo "IMAGE_URI=$REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV

      # --- FASE 4: DESPLIEGUE FINAL (Update ECS) ---

      - name: üöÄ 8. Deploy New Version via Terraform
        run: |
          echo "Actualizando ECS con la imagen: ${{ env.IMAGE_URI }}"
          
          # Volvemos a correr Terraform.
          # Al cambiar la variable 'app_image', Terraform detecta que la Task Definition cambi√≥
          # y fuerza a Fargate a rotar los contenedores.
          terraform apply -auto-approve \
            -var="app_image=${{ env.IMAGE_URI }}"
            
      - name: ‚úÖ 9. Show Load Balancer URL
        run: |
          echo "DEPLOY SUCCESS!"
          echo "üåç Tu App est√° viva en: http://$(terraform output -raw alb_dns_name)"
